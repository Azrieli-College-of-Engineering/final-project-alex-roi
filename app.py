"""
app.py - ×©×¨×ª Flask
==================
×©×¨×ª ×”××™× ×˜×¨× ×˜ ×”××¡×¤×§ ××ª ×”-API ×•×”-Dashboard.

Flask Server providing the API endpoints and Dashboard.
"""

from flask import Flask, render_template, jsonify, request
from database import (
    init_database, reset_database, get_wallet_balance,
    get_all_users, get_audit_log, INITIAL_BALANCE, UPGRADE_COST
)
from services import vulnerable_upgrade, secure_upgrade
import os

app = Flask(__name__)

# ×•×“× ×©×”×“××˜××‘×™×™×¡ ×§×™×™×
if not os.path.exists('saas_platform.db'):
    init_database()


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ–¥ï¸ FRONTEND ROUTES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@app.route('/')
def dashboard():
    """×“×£ ×”×“××©×‘×•×¨×“ ×”×¨××©×™"""
    return render_template('dashboard.html')


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“Š API ROUTES - DATA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@app.route('/api/stats')
def get_stats():
    """
    ×§×‘×œ×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª ×”××¢×¨×›×ª ×‘×–××Ÿ ×××ª.
    ××©××© ××ª ×”×“××©×‘×•×¨×“ ×œ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”.
    """
    balance = get_wallet_balance()
    users = get_all_users()
    logs = get_audit_log()
    
    premium_count = sum(1 for u in users if u['is_premium'])
    free_count = len(users) - premium_count
    
    return jsonify({
        "wallet": {
            "balance": balance,
            "initial": INITIAL_BALANCE,
            "is_negative": balance < 0
        },
        "users": users,
        "stats": {
            "total": len(users),
            "premium": premium_count,
            "free": free_count
        },
        "logs": logs,
        "config": {
            "upgrade_cost": UPGRADE_COST
        }
    })


@app.route('/api/logs')
def get_logs():
    """×§×‘×œ×ª ×œ×•×’ ×”×¤×¢×•×œ×•×ª"""
    return jsonify(get_audit_log())


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”´ API ROUTES - VULNERABLE ENDPOINT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@app.route('/api/upgrade', methods=['POST'])
def upgrade_endpoint():
    """
    ğŸ”´ × ×§×•×“×ª ×§×¦×” ×¤×’×™×¢×” ×œ×©×“×¨×•×’ ××©×ª××©.
    
    ×–×•×”×™ × ×§×•×“×ª ×”×§×¦×” ×©×¢×œ×™×” ××ª×‘×¦×¢×ª ×”××ª×§×¤×”!
    ×”×™× ×§×•×¨××ª ×œ×¤×•× ×§×¦×™×” vulnerable_upgrade ×©××›×™×œ×” ××ª ×—×œ×•×Ÿ ×”×¤×’×™×¢×•×ª.
    
    Request Body:
        {"user_id": 1}
    """
    data = request.get_json()
    user_id = data.get('user_id')
    
    if not user_id:
        return jsonify({"success": False, "error": "×—×¡×¨ user_id"}), 400
    
    result = vulnerable_upgrade(user_id)
    
    # ××—×–×™×¨×™× 200 OK ×’× ×× ×”×¤×¢×•×œ×” × ×›×©×œ×” (×œ×¦×•×¨×š ×”×“×’××”)
    # ×‘×¡×‘×™×‘×” ×××™×ª×™×ª ×”×™×™× ×• ××—×–×™×¨×™× ×§×•×“ ×©×’×™××” ××ª××™×
    return jsonify(result)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸŸ¢ API ROUTES - SECURE ENDPOINT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@app.route('/api/upgrade/secure', methods=['POST'])
def secure_upgrade_endpoint():
    """
    ğŸŸ¢ × ×§×•×“×ª ×§×¦×” ×××•×‘×˜×—×ª ×œ×©×“×¨×•×’ ××©×ª××©.
    
    ×–×•×”×™ × ×§×•×“×ª ×”×§×¦×” ×”××ª×•×§× ×ª!
    ×”×™× ×§×•×¨××ª ×œ×¤×•× ×§×¦×™×” secure_upgrade ×©××©×ª××©×ª ×‘×¢×“×›×•×Ÿ ××˜×•××™.
    
    Request Body:
        {"user_id": 1}
    """
    data = request.get_json()
    user_id = data.get('user_id')
    
    if not user_id:
        return jsonify({"success": False, "error": "×—×¡×¨ user_id"}), 400
    
    result = secure_upgrade(user_id)
    return jsonify(result)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”„ API ROUTES - MANAGEMENT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@app.route('/api/reset', methods=['POST'])
def reset_endpoint():
    """
    ××™×¤×•×¡ ×”××¢×¨×›×ª ×œ××¦×‘ ×”×ª×—×œ×ª×™.
    ××©××© ×œ×”×¨×¦×” ×—×•×–×¨×ª ×©×œ ×”×”×“×’××”.
    """
    reset_database()
    return jsonify({
        "success": True,
        "message": "×”××¢×¨×›×ª ××•×¤×¡×” ×‘×”×¦×œ×—×”",
        "balance": INITIAL_BALANCE
    })


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš€ SERVER STARTUP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if __name__ == '__main__':
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                   â•‘
â•‘   ğŸ”¬ Race Condition Lab - SaaS Platform Simulation               â•‘
â•‘                                                                   â•‘
â•‘   Dashboard: http://localhost:5000                                â•‘
â•‘                                                                   â•‘
â•‘   API Endpoints:                                                  â•‘
â•‘   â€¢ GET  /api/stats         - ×¡×˜×˜×™×¡×˜×™×§×•×ª                         â•‘
â•‘   â€¢ POST /api/upgrade       - ğŸ”´ ×©×“×¨×•×’ ×¤×’×™×¢                       â•‘
â•‘   â€¢ POST /api/upgrade/secure - ğŸŸ¢ ×©×“×¨×•×’ ×××•×‘×˜×—                    â•‘
â•‘   â€¢ POST /api/reset         - ××™×¤×•×¡ ×”××¢×¨×›×ª                        â•‘
â•‘                                                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    # ×”×¤×¢×œ×ª ×”×©×¨×ª
    # threaded=True ×××¤×©×¨ ×˜×™×¤×•×œ ×‘×‘×§×©×•×ª ××§×‘×™×œ×™×•×ª
    app.run(debug=True, threaded=True, port=5000)
